# 注册功能使用指南

## 修改内容总结

### 1. 前端修改（线上图书系统）

#### Register.vue 组件修改
- ✅ 更新表单字段：
  - 保留：用户名 (username)
  - 删除：用户昵称 (nickname)、手机号 (phone)
  - 新增：邮箱地址 (email)
  - 保留：密码 (password)、确认密码 (confirmPassword)

- ✅ 表单验证更新：
  - 用户名：至少3个字符
  - 邮箱：标准邮箱格式验证 (xxx@xxx.xxx)
  - 密码：至少6个字符
  - 确认密码：与密码一致

- ✅ 图标更新：
  - 用户名：User 图标
  - 邮箱：Message 图标
  - 密码：Lock 图标

### 2. 后端修改（backend）

- ✅ 添加 CORS 支持 (flask-cors)
- ✅ 更新 requirements.txt 添加 flask-cors==4.0.0
- ✅ 注册 API 已配置：POST /api/register
  - 接收字段：username, email, password
  - 自动设置：role='user', status='active'
  - 返回用户信息

### 3. 数据库表结构（users表）

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,      -- 用户名
  password VARCHAR(255) NOT NULL,            -- 密码
  email VARCHAR(100) NOT NULL UNIQUE,        -- 邮箱
  role ENUM('admin', 'user') DEFAULT 'user', -- 角色
  status ENUM('active', 'inactive') DEFAULT 'active', -- 状态
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 安装步骤

### 1. 安装后端依赖

```bash
# 进入后端目录
cd D:\AAA\backend

# 激活虚拟环境 (如果使用虚拟环境)
# Windows:
venv\Scripts\activate

# 安装新依赖 flask-cors
pip install flask-cors==4.0.0

# 或者重新安装所有依赖
pip install -r requirements.txt
```

### 2. 确认数据库配置

检查 `D:\AAA\backend\.env` 文件，确保数据库连接信息正确：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=你的密码
DB_NAME=bookstore_management_system
SECRET_KEY=your-secret-key-here
```

### 3. 确认数据库表已创建

确保已运行 `D:\AAA\mysql_database.sql` 创建了 users 表。

## 启动和测试

### 1. 启动后端服务

```bash
cd D:\AAA\backend
python app.py
```

后端应该运行在：http://localhost:5000

### 2. 启动前端服务

```bash
cd D:\AAA\线上图书系统
npm run dev
```

前端应该运行在：http://localhost:5173 (或其他Vite指定的端口)

### 3. 测试注册功能

1. 在浏览器打开前端地址
2. 导航到注册页面 (路由：/register)
3. 填写注册表单：
   - **用户名**：输入至少3个字符的用户名
   - **邮箱地址**：输入有效的邮箱格式（例如：user@example.com）
   - **密码**：输入至少6个字符的密码
   - **确认密码**：再次输入相同的密码
4. 点击"立即注册"按钮
5. 注册成功后会自动跳转到登录页面

### 4. 验证注册数据

#### 方法1：使用后端API

```bash
# 获取所有用户
curl http://localhost:5000/api/users
```

#### 方法2：直接查询数据库

```sql
USE bookstore_management_system;
SELECT id, username, email, role, status, created_at FROM users;
```

### 5. 测试登录功能

注册成功后，使用刚才注册的用户名和密码进行登录：

1. 进入登录页面 (路由：/login)
2. 输入用户名和密码
3. 点击"立即登录"
4. 登录成功后会跳转到主页，并将用户信息保存到 localStorage

## 注意事项

### 密码安全
⚠️ **当前版本的密码是明文存储！** 这仅用于开发测试。

在生产环境中，应该：
1. 使用 bcrypt 对密码进行加密
2. 在注册和登录时对密码进行哈希处理
3. 永远不要在日志或响应中暴露原始密码

### 表单验证规则

- **用户名**：
  - 长度：≥ 3 个字符
  - 唯一性：数据库中不能重复

- **邮箱**：
  - 格式：符合标准邮箱格式
  - 唯一性：数据库中不能重复

- **密码**：
  - 长度：≥ 6 个字符
  - 确认密码必须匹配

### 错误处理

注册可能失败的情况：
- ❌ 用户名已存在 → 提示"用户名已存在"
- ❌ 邮箱已注册 → 提示"邮箱已被注册"
- ❌ 数据库连接失败 → 提示"注册失败，请稍后重试"
- ❌ 表单验证失败 → 显示相应的验证错误提示

## API接口说明

### 注册接口

```
POST /api/register
Content-Type: application/json

请求体：
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123"
}

成功响应 (200)：
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "role": "user",
    "status": "active",
    "created_at": "2025-10-15 10:30:00"
  }
}

失败响应 (400)：
{
  "code": 400,
  "message": "用户名已存在"
}
```

### 登录接口

```
POST /api/login
Content-Type: application/json

请求体：
{
  "username": "testuser",
  "password": "password123"
}

成功响应 (200)：
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "mock-jwt-token-testuser-1",
    "user_id": 1,
    "username": "testuser",
    "role": "user"
  }
}

失败响应 (401)：
{
  "code": 401,
  "message": "用户名或密码错误"
}
```

## 开发建议

### 未来改进方向

1. **密码加密**：使用 bcrypt 对密码进行哈希处理
2. **JWT认证**：实现真正的JWT令牌认证机制
3. **邮箱验证**：发送验证邮件确认邮箱有效性
4. **表单增强**：添加更多验证规则（密码强度、用户名格式等）
5. **图形验证码**：防止自动化注册攻击
6. **限流机制**：防止暴力注册

## 故障排查

### 问题1：前端无法连接后端

**症状**：注册时显示"网络错误，服务器无响应"

**解决方案**：
1. 确认后端服务已启动（http://localhost:5000）
2. 检查 Vite 代理配置（vite.config.ts）
3. 检查浏览器控制台的网络请求

### 问题2：CORS错误

**症状**：浏览器控制台显示 CORS policy 错误

**解决方案**：
1. 确认已安装 flask-cors
2. 确认 app.py 中已添加 CORS 配置
3. 重启后端服务

### 问题3：数据库连接失败

**症状**：后端日志显示数据库连接错误

**解决方案**：
1. 检查 MySQL 服务是否运行
2. 验证 .env 文件中的数据库配置
3. 确认数据库和表已创建
4. 测试数据库连接：`python test_db_connection.py`

### 问题4：注册后无法登录

**症状**：注册成功但登录失败

**解决方案**：
1. 检查数据库中是否成功插入用户数据
2. 确认用户 status 字段为 'active'
3. 确认登录时使用的是用户名（不是邮箱）

## 测试用例

### 正常流程测试

```
测试1：成功注册
- 用户名：testuser001
- 邮箱：test001@example.com
- 密码：123456
预期：注册成功，跳转到登录页

测试2：成功登录
- 用户名：testuser001
- 密码：123456
预期：登录成功，跳转到首页
```

### 异常流程测试

```
测试3：用户名重复
- 使用已存在的用户名注册
预期：提示"用户名已存在"

测试4：邮箱重复
- 使用已注册的邮箱注册
预期：提示"邮箱已被注册"

测试5：密码不一致
- 密码和确认密码输入不同
预期：提示"两次输入的密码不一致"

测试6：邮箱格式错误
- 输入无效邮箱格式（如：test@）
预期：提示"请输入有效的邮箱地址"

测试7：用户名太短
- 输入少于3个字符的用户名
预期：提示"用户名长度至少为3位"
```

## 技术栈

- **前端**：Vue 3 + TypeScript + Element Plus + Vite
- **后端**：Flask + SQLAlchemy + PyMySQL
- **数据库**：MySQL 8.0
- **认证**：简单Token机制（待升级为JWT）

---

**文档创建时间**：2025-10-15
**最后更新**：2025-10-15
