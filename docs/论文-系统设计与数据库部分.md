# 线上书店管理系统 - 系统设计与数据库实现

## 第三章 系统功能结构设计

### 3.1 系统总体架构

本系统采用前后端分离的架构模式，整体分为三个主要部分：后端服务层、管理端前台和用户端前台。系统架构遵循MVC设计模式，实现了业务逻辑与数据展示的分离，提高了系统的可维护性和可扩展性。

#### 3.1.1 技术架构

**后端技术栈：**
- 开发语言：Python 3.x
- Web框架：Flask 2.x
- 数据库：MySQL 8.0
- ORM工具：SQLAlchemy
- API风格：RESTful API

**前端技术栈：**
- 开发框架：Vue 3.x
- 开发语言：TypeScript
- UI组件库：Element Plus
- 构建工具：Vite
- 状态管理：Pinia
- 路由管理：Vue Router 4.x

**开发工具：**
- 版本控制：Git
- 接口测试：Postman
- 数据库管理：MySQL Workbench

### 3.2 系统功能模块设计

根据系统需求分析，本系统主要包含以下功能模块：

#### 3.2.1 用户管理模块

用户管理模块是系统的核心模块之一，负责管理系统中所有用户的信息和权限。

**主要功能：**

1. **用户注册**
   - 用户信息录入（用户名、密码、邮箱）
   - 用户名唯一性验证
   - 邮箱格式验证
   - 密码加密存储

2. **用户登录**
   - 用户身份认证
   - 登录状态维持（Token机制）
   - 角色权限判断（管理员/普通用户）

3. **用户信息管理**
   - 查看用户列表
   - 添加新用户
   - 编辑用户信息
   - 删除用户
   - 用户状态管理（启用/禁用）

4. **用户权限管理**
   - 角色分配（管理员/普通用户）
   - 权限验证
   - 基于角色的访问控制（RBAC）

**业务流程：**

用户注册流程：
```
开始 → 填写注册信息 → 验证信息合法性 → 检查用户名/邮箱是否已存在
→ 密码加密 → 写入数据库 → 返回注册结果 → 结束
```

用户登录流程：
```
开始 → 输入用户名和密码 → 验证用户是否存在 → 验证密码是否正确
→ 检查用户状态（是否被禁用） → 生成访问令牌 → 返回用户信息和令牌 → 结束
```

#### 3.2.2 图书管理模块

图书管理模块负责系统中图书信息的全生命周期管理。

**主要功能：**

1. **图书信息管理**
   - 添加图书（书名、作者、ISBN、分类、价格、库存等）
   - 编辑图书信息
   - 删除图书
   - 图书列表查询
   - 图书详情查看

2. **图书分类管理**
   - 添加图书分类
   - 编辑分类信息
   - 删除分类
   - 分类列表查询

3. **库存管理**
   - 库存数量查询
   - 库存预警（低库存提醒）
   - 库存更新

4. **图书检索**
   - 按书名搜索
   - 按作者搜索
   - 按分类筛选
   - 综合搜索

**业务流程：**

图书添加流程：
```
开始 → 填写图书信息 → 验证ISBN唯一性 → 验证必填字段
→ 查找可用ID（填补ID空缺） → 写入数据库 → 返回添加结果 → 结束
```

图书查询流程：
```
开始 → 接收查询条件 → 构建SQL查询语句 → 关联分类表查询
→ 返回图书列表（含分类信息） → 结束
```

#### 3.2.3 订单管理模块

订单管理模块处理用户的购书交易流程。

**主要功能：**

1. **购物车管理**
   - 添加图书到购物车
   - 修改购物车数量
   - 删除购物车商品
   - 查看购物车

2. **订单处理**
   - 创建订单
   - 订单支付
   - 订单查询
   - 订单详情查看

3. **销售记录管理**
   - 销售记录查询
   - 销售统计分析
   - 订单编号生成

**业务流程：**

订单创建流程：
```
开始 → 用户提交订单 → 验证库存是否充足 → 计算订单总金额
→ 生成订单编号 → 创建销售记录 → 扣减库存 → 返回订单信息 → 结束
```

#### 3.2.4 评论评分模块

评论评分模块让用户能够对购买的图书进行评价和打分。

**主要功能：**

1. **评论管理**
   - 发表评论
   - 查看评论
   - 删除评论

2. **评分管理**
   - 用户评分（1-5分）
   - 计算平均评分
   - 评分统计

3. **评论展示**
   - 按时间排序
   - 关联用户信息
   - 评论分页

#### 3.2.5 系统管理模块

系统管理模块提供系统级的管理功能，仅管理员可访问。

**主要功能：**

1. **权限管理**
   - 权限定义
   - 角色权限分配
   - 权限验证

2. **操作日志管理**
   - 记录用户操作
   - 日志查询
   - 操作审计

3. **系统配置**
   - 系统参数配置
   - 数据库连接管理
   - 系统健康检查

**业务流程：**

操作日志记录流程：
```
开始 → 用户执行操作 → 记录操作类型 → 记录操作用户
→ 记录操作描述 → 记录IP地址 → 写入日志表 → 结束
```

### 3.3 系统功能结构图

```
线上书店管理系统
├── 用户管理模块
│   ├── 用户注册
│   ├── 用户登录
│   ├── 用户信息管理
│   └── 用户权限管理
├── 图书管理模块
│   ├── 图书信息管理
│   ├── 图书分类管理
│   ├── 库存管理
│   └── 图书检索
├── 订单管理模块
│   ├── 购物车管理
│   ├── 订单处理
│   └── 销售记录管理
├── 评论评分模块
│   ├── 评论管理
│   ├── 评分管理
│   └── 评论展示
└── 系统管理模块
    ├── 权限管理
    ├── 操作日志管理
    └── 系统配置
```

### 3.4 系统角色定义

本系统定义了两种用户角色，每种角色具有不同的权限和功能访问范围。

#### 3.4.1 管理员角色

**权限范围：**
- 用户管理权限（user_manage）
- 图书管理权限（book_manage）
- 分类管理权限（category_manage）
- 销售记录管理权限（sales_manage）
- 评论管理权限（review_manage）
- 系统配置权限（system_config）
- 日志查看权限（log_view）

**可访问功能：**
- 管理端所有功能
- 用户端所有功能

#### 3.4.2 普通用户角色

**权限范围：**
- 浏览图书
- 购买图书
- 管理个人购物车
- 查看个人订单
- 发表评论评分

**可访问功能：**
- 用户端功能

### 3.5 系统接口设计

系统采用RESTful API设计风格，所有接口返回统一的JSON格式：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

**主要API接口：**

| 接口路径 | 请求方法 | 功能描述 | 权限要求 |
|---------|---------|---------|---------|
| /api/login | POST | 用户登录 | 无 |
| /api/users | GET | 获取用户列表 | 管理员 |
| /api/users | POST | 添加用户 | 管理员 |
| /api/users/:id | PUT | 更新用户信息 | 管理员 |
| /api/users/:id | DELETE | 删除用户 | 管理员 |
| /api/users/:id/status | PATCH | 修改用户状态 | 管理员 |
| /api/books | GET | 获取图书列表 | 无 |
| /api/books | POST | 添加图书 | 管理员 |
| /api/books/:id | PUT | 更新图书信息 | 管理员 |
| /api/books/:id | DELETE | 删除图书 | 管理员 |
| /api/categories | GET | 获取分类列表 | 无 |
| /api/cart/add | POST | 添加购物车 | 登录用户 |
| /api/cart | GET | 查看购物车 | 登录用户 |
| /api/orders/create | POST | 创建订单 | 登录用户 |
| /api/orders | GET | 查看订单列表 | 登录用户 |

---

## 第四章 数据库设计

### 4.1 数据库设计原则

本系统数据库设计遵循以下原则：

1. **规范化原则**：数据库设计遵循第三范式（3NF），减少数据冗余，提高数据一致性。
2. **完整性原则**：通过主键、外键、唯一约束等确保数据完整性。
3. **安全性原则**：敏感数据（如密码）进行加密存储，实施权限控制。
4. **扩展性原则**：预留扩展字段，便于未来功能扩展。
5. **性能优化原则**：合理设计索引，优化查询性能。

### 4.2 数据库概念模型设计（E-R图）

#### 4.2.1 实体定义

**用户实体（Users）**
- 用户ID（主键）
- 用户名
- 密码
- 邮箱
- 角色
- 状态
- 创建时间
- 更新时间

**图书实体（Books）**
- 图书ID（主键）
- ISBN
- 书名
- 作者
- 分类ID（外键）
- 描述
- 价格
- 库存
- 评分
- 封面图片
- 状态
- 创建时间
- 更新时间

**图书分类实体（Categories）**
- 分类ID（主键）
- 分类名称
- 分类描述
- 创建时间
- 更新时间

**权限实体（Permissions）**
- 权限ID（主键）
- 权限名称
- 权限描述
- 创建时间
- 更新时间

**销售记录实体（Sales Records）**
- 销售记录ID（主键）
- 用户ID（外键）
- 图书ID（外键）
- 数量
- 单价
- 总金额
- 销售日期
- 订单编号
- 创建时间
- 更新时间

**评论实体（Reviews）**
- 评论ID（主键）
- 用户ID（外键）
- 图书ID（外键）
- 评分
- 评论内容
- 评论时间
- 更新时间

**操作日志实体（Operation Logs）**
- 日志ID（主键）
- 用户ID（外键）
- 操作类型
- 操作描述
- IP地址
- 操作时间

#### 4.2.2 实体关系描述

1. **用户与销售记录**：一对多关系
   - 一个用户可以有多条购买记录
   - 一条销售记录属于一个用户

2. **图书与销售记录**：一对多关系
   - 一本图书可以有多条销售记录
   - 一条销售记录对应一本图书

3. **用户与评论**：一对多关系
   - 一个用户可以发表多条评论
   - 一条评论属于一个用户

4. **图书与评论**：一对多关系
   - 一本图书可以有多条评论
   - 一条评论针对一本图书

5. **分类与图书**：一对多关系
   - 一个分类可以包含多本图书
   - 一本图书属于一个分类

6. **角色与权限**：多对多关系
   - 一个角色可以拥有多个权限
   - 一个权限可以分配给多个角色
   - 通过role_permissions关联表实现

7. **用户与操作日志**：一对多关系
   - 一个用户可以产生多条操作日志
   - 一条操作日志属于一个用户

### 4.3 数据库逻辑模型设计

#### 4.3.1 用户表（users）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 用户ID |
| username | VARCHAR | 50 | | √ | √ | | 用户名 |
| password | VARCHAR | 255 | | √ | | | 密码（加密存储） |
| email | VARCHAR | 100 | | √ | √ | | 邮箱 |
| role | ENUM | - | | √ | | 'user' | 角色（admin/user） |
| status | ENUM | - | | √ | | 'active' | 状态（active/inactive） |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）
- 唯一约束：username、email
- 索引：idx_username、idx_email

#### 4.3.2 图书表（books）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 图书ID |
| isbn | VARCHAR | 20 | | | √ | | 国际标准书号 |
| title | VARCHAR | 100 | | √ | | | 书名 |
| author | VARCHAR | 100 | | √ | | | 作者 |
| category_id | INT | - | | | | | 分类ID |
| description | TEXT | - | | | | | 图书描述 |
| price | DECIMAL | 10,2 | | √ | | 0.00 | 价格 |
| stock | INT | - | | √ | | 0 | 库存数量 |
| rating | DECIMAL | 3,2 | | | | 0.00 | 评分（0-5分） |
| image | VARCHAR | 255 | | | | | 封面图片路径 |
| status | ENUM | - | | √ | | 'available' | 状态 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）
- 外键：category_id → categories(id)
- 唯一约束：isbn
- 索引：idx_title、idx_author、idx_category_id

#### 4.3.3 图书分类表（categories）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 分类ID |
| name | VARCHAR | 50 | | √ | √ | | 分类名称 |
| description | VARCHAR | 255 | | | | | 分类描述 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）
- 唯一约束：name

#### 4.3.4 权限表（permissions）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 权限ID |
| name | VARCHAR | 50 | | √ | | | 权限名称 |
| description | VARCHAR | 255 | | | | | 权限描述 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）

#### 4.3.5 角色权限关联表（role_permissions）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| role_name | ENUM | - | √ | √ | | | 角色名称（admin/user） |
| permission_id | INT | - | √ | √ | | | 权限ID |

**约束条件：**
- 联合主键：(role_name, permission_id)
- 外键：permission_id → permissions(id)

#### 4.3.6 销售记录表（sales_records）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 销售记录ID |
| user_id | INT | - | | | | | 购买用户ID |
| book_id | INT | - | | √ | | | 图书ID |
| quantity | INT | - | | √ | | 1 | 销售数量 |
| unit_price | DECIMAL | 10,2 | | √ | | 0.00 | 单价 |
| total_amount | DECIMAL | 10,2 | | √ | | 0.00 | 总金额 |
| sale_date | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 销售日期 |
| order_number | VARCHAR | 100 | | | √ | | 订单编号 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）
- 外键：user_id → users(id)、book_id → books(id)
- 唯一约束：order_number
- 索引：idx_user_id、idx_book_id、idx_sale_date

#### 4.3.7 评论表（reviews）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 评论ID |
| user_id | INT | - | | √ | | | 用户ID |
| book_id | INT | - | | √ | | | 图书ID |
| rating | INT | - | | √ | | | 评分（1-5分） |
| comment | TEXT | - | | | | | 评论内容 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 评论时间 |
| updated_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 更新时间 |

**约束条件：**
- 主键：id（自增）
- 外键：user_id → users(id)、book_id → books(id)
- 索引：idx_user_id、idx_book_id

#### 4.3.8 操作日志表（operation_logs）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|-------|---------|------|------|------|------|--------|------|
| id | INT | - | √ | √ | √ | AUTO_INCREMENT | 日志ID |
| user_id | INT | - | | | | | 操作用户ID |
| operation_type | VARCHAR | 50 | | √ | | | 操作类型 |
| operation_desc | TEXT | - | | | | | 操作描述 |
| ip_address | VARCHAR | 50 | | | | | IP地址 |
| created_at | TIMESTAMP | - | | | | CURRENT_TIMESTAMP | 操作时间 |

**约束条件：**
- 主键：id（自增）
- 外键：user_id → users(id)
- 索引：idx_user_id、idx_created_at

### 4.4 数据库视图设计

为了简化常用查询和提高查询效率，系统设计了以下视图：

#### 4.4.1 活跃用户视图（v_active_users）

**功能说明：** 查询所有状态为活跃的用户，供管理员快速查看可用用户列表。

**SQL定义：**
```sql
CREATE VIEW v_active_users AS
SELECT id, username, email, role, created_at, updated_at
FROM users
WHERE status = 'active';
```

#### 4.4.2 图书分类视图（v_book_with_category）

**功能说明：** 将图书信息与分类信息关联，便于前端直接显示图书分类名称。

**SQL定义：**
```sql
CREATE VIEW v_book_with_category AS
SELECT
  b.id,
  b.title,
  b.author,
  c.name AS category,
  b.description,
  b.price,
  b.stock,
  b.rating,
  b.image,
  b.status,
  b.created_at,
  b.updated_at
FROM books b
LEFT JOIN categories c ON b.category_id = c.id;
```

#### 4.4.3 热门图书视图（v_popular_books）

**功能说明：** 查询评分高于4.5分的前10本图书，按评分和评论数量排序。

**SQL定义：**
```sql
CREATE VIEW v_popular_books AS
SELECT
  b.id,
  b.title,
  b.author,
  b.price,
  b.rating,
  COUNT(r.id) AS review_count
FROM books b
LEFT JOIN reviews r ON b.id = r.book_id
WHERE b.rating >= 4.5
GROUP BY b.id
ORDER BY b.rating DESC, review_count DESC
LIMIT 10;
```

### 4.5 数据库安全设计

#### 4.5.1 数据加密

- **密码加密：** 用户密码使用bcrypt加密算法进行加密存储，防止明文泄露。
- **敏感信息保护：** 邮箱等敏感信息仅管理员可见。

#### 4.5.2 访问控制

- **用户认证：** 通过Token机制验证用户身份。
- **权限控制：** 基于RBAC（基于角色的访问控制）模型，不同角色拥有不同权限。
- **SQL注入防护：** 使用参数化查询，防止SQL注入攻击。

#### 4.5.3 数据备份

- **定期备份：** 建议每日进行数据库完整备份。
- **增量备份：** 关键业务时段进行增量备份。
- **异地备份：** 备份文件存储于不同物理位置，防止单点故障。

---

## 第五章 数据库实现

### 5.1 数据库创建

#### 5.1.1 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS bookstore_management_system;
USE bookstore_management_system;
```

**说明：**
- 数据库名称：bookstore_management_system
- 字符集：utf8mb4（支持中文及特殊字符）
- 存储引擎：InnoDB（支持事务和外键）

### 5.2 数据表创建

#### 5.2.1 用户表创建

```sql
CREATE TABLE IF NOT EXISTS users (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
  role ENUM('admin', 'user') NOT NULL DEFAULT 'user' COMMENT '角色',
  status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT '状态',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';
```

**设计说明：**
- `id`：自增主键，唯一标识用户
- `username`：用户名设置唯一约束，防止重复注册
- `password`：密码字段长度255，足够存储加密后的密码
- `email`：邮箱设置唯一约束
- `role`：使用ENUM类型限制角色只能是admin或user
- `status`：使用ENUM类型管理用户状态
- `created_at`和`updated_at`：自动记录创建和更新时间

#### 5.2.2 权限表创建

```sql
CREATE TABLE IF NOT EXISTS permissions (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '权限ID',
  name VARCHAR(50) NOT NULL COMMENT '权限名称',
  description VARCHAR(255) COMMENT '权限描述',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统权限表';
```

#### 5.2.3 角色权限关联表创建

```sql
CREATE TABLE IF NOT EXISTS role_permissions (
  role_name ENUM('admin', 'user') NOT NULL COMMENT '角色名称',
  permission_id INT NOT NULL COMMENT '权限ID',
  PRIMARY KEY (role_name, permission_id),
  FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

**设计说明：**
- 使用联合主键(role_name, permission_id)确保角色和权限的组合唯一
- 外键约束确保引用完整性
- ON DELETE CASCADE：当权限被删除时，自动删除相关的角色权限记录

#### 5.2.4 操作日志表创建

```sql
CREATE TABLE IF NOT EXISTS operation_logs (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
  user_id INT COMMENT '操作用户ID',
  operation_type VARCHAR(50) NOT NULL COMMENT '操作类型',
  operation_desc TEXT COMMENT '操作描述',
  ip_address VARCHAR(50) COMMENT 'IP地址',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统操作日志表';
```

**设计说明：**
- user_id外键设置ON DELETE SET NULL，当用户被删除时保留日志记录，但将用户ID设为NULL
- operation_desc使用TEXT类型，可存储较长的操作描述

#### 5.2.5 图书分类表创建

```sql
CREATE TABLE IF NOT EXISTS categories (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
  name VARCHAR(50) NOT NULL UNIQUE COMMENT '分类名称',
  description VARCHAR(255) COMMENT '分类描述',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图书分类表';
```

#### 5.2.6 图书表创建

```sql
CREATE TABLE IF NOT EXISTS books (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '图书ID',
  isbn VARCHAR(20) UNIQUE COMMENT '国际标准书号',
  title VARCHAR(100) NOT NULL COMMENT '书名',
  author VARCHAR(100) NOT NULL COMMENT '作者',
  category_id INT COMMENT '分类ID',
  description TEXT COMMENT '图书描述',
  price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '价格',
  stock INT NOT NULL DEFAULT 0 COMMENT '库存数量',
  rating DECIMAL(3,2) DEFAULT 0.00 COMMENT '评分',
  image VARCHAR(255) COMMENT '图书封面图片路径',
  status ENUM('available', 'unavailable') NOT NULL DEFAULT 'available' COMMENT '状态',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图书表';
```

**设计说明：**
- `isbn`：国际标准书号，设置唯一约束
- `price`：DECIMAL(10,2)精确存储价格，支持最大99999999.99元
- `stock`：整型存储库存数量
- `rating`：DECIMAL(3,2)存储评分，支持0.00-5.00的精确评分
- `category_id`外键设置ON DELETE SET NULL，分类删除时不删除图书，仅将分类设为NULL

#### 5.2.7 销售记录表创建

```sql
CREATE TABLE IF NOT EXISTS sales_records (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '销售记录ID',
  user_id INT COMMENT '购买用户ID',
  book_id INT NOT NULL COMMENT '图书ID',
  quantity INT NOT NULL DEFAULT 1 COMMENT '销售数量',
  unit_price DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '单价',
  total_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '销售总金额',
  sale_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '销售日期',
  order_number VARCHAR(100) UNIQUE COMMENT '订单编号',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图书销售记录表';
```

**设计说明：**
- `order_number`：订单编号设置唯一约束
- `user_id`外键ON DELETE SET NULL：用户删除后保留销售记录
- `book_id`外键ON DELETE CASCADE：图书删除时删除相关销售记录
- `total_amount`：自动计算total = quantity × unit_price

#### 5.2.8 评论表创建

```sql
CREATE TABLE IF NOT EXISTS reviews (
  id INT PRIMARY KEY AUTO_INCREMENT COMMENT '评论ID',
  user_id INT NOT NULL COMMENT '用户ID',
  book_id INT NOT NULL COMMENT '图书ID',
  rating INT NOT NULL COMMENT '评分(1-5分)',
  comment TEXT COMMENT '评论内容',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '评论时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (book_id) REFERENCES books(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图书评论表';
```

**设计说明：**
- 用户和图书外键均设置ON DELETE CASCADE，删除用户或图书时同时删除相关评论
- `rating`：整型存储1-5的评分值

### 5.3 索引创建

为了提高查询性能，对常用查询字段创建索引：

```sql
-- 用户表索引
ALTER TABLE users ADD INDEX idx_username (username);
ALTER TABLE users ADD INDEX idx_email (email);

-- 图书表索引
ALTER TABLE books ADD INDEX idx_title (title);
ALTER TABLE books ADD INDEX idx_author (author);
ALTER TABLE books ADD INDEX idx_category_id (category_id);

-- 销售记录表索引
ALTER TABLE sales_records ADD INDEX idx_user_id (user_id);
ALTER TABLE sales_records ADD INDEX idx_book_id (book_id);
ALTER TABLE sales_records ADD INDEX idx_sale_date (sale_date);

-- 评论表索引
ALTER TABLE reviews ADD INDEX idx_user_id (user_id);
ALTER TABLE reviews ADD INDEX idx_book_id (book_id);

-- 操作日志表索引
ALTER TABLE operation_logs ADD INDEX idx_user_id (user_id);
ALTER TABLE operation_logs ADD INDEX idx_created_at (created_at);
```

**索引说明：**
- **idx_username和idx_email**：加速用户登录和查找
- **idx_title和idx_author**：加速图书搜索
- **idx_category_id**：加速按分类查询图书
- **idx_sale_date**：加速销售记录的时间范围查询
- **idx_user_id和idx_book_id**：加速关联查询

### 5.4 初始数据插入

#### 5.4.1 插入管理员账户

```sql
INSERT INTO users (username, password, email, role, status)
VALUES ('admin', '$2a$10$Q4V8C3e0D1r5T6y7U8i9o7P3L2K1J0H9G8F7E6D5C4B3A2',
        'admin@example.com', 'admin', 'active');
```

**说明：**
- 创建默认管理员账户
- 密码经过bcrypt加密处理
- 默认邮箱为admin@example.com

#### 5.4.2 插入初始权限数据

```sql
INSERT INTO permissions (name, description) VALUES
('user_manage', '用户管理权限'),
('book_manage', '图书管理权限'),
('category_manage', '分类管理权限'),
('sales_manage', '销售记录管理权限'),
('review_manage', '评论管理权限'),
('system_config', '系统配置权限'),
('log_view', '日志查看权限');
```

#### 5.4.3 为管理员分配权限

```sql
INSERT INTO role_permissions (role_name, permission_id) VALUES
('admin', 1),  -- user_manage
('admin', 2),  -- book_manage
('admin', 3),  -- category_manage
('admin', 4),  -- sales_manage
('admin', 5),  -- review_manage
('admin', 6),  -- system_config
('admin', 7);  -- log_view
```

**说明：** 管理员角色拥有系统所有权限。

#### 5.4.4 插入图书分类数据

```sql
INSERT INTO categories (name, description) VALUES
('技术', '计算机科学、编程、软件开发等相关图书'),
('文学', '小说、诗歌、散文等文学作品'),
('历史', '历史事件、人物传记等历史类图书'),
('科学', '自然科学、社会科学等学术类图书'),
('艺术', '绘画、音乐、设计等艺术类图书'),
('哲学', '哲学思想、逻辑学等哲学类图书'),
('心理学', '心理学理论、心理辅导等心理学类图书'),
('经济', '经济学理论、金融投资等经济类图书'),
('管理', '企业管理、项目管理等管理类图书'),
('生活', '生活技巧、健康养生等生活类图书');
```

**说明：** 系统预设10个常用图书分类。

#### 5.4.5 插入示例图书数据

系统插入了48本示例图书，涵盖所有10个分类，包括：

**技术类（分类ID=1）：**
- Vue.js 3 权威指南（¥89.00，库存50）
- React 深度指南（¥99.00，库存30）
- JavaScript高级程序设计（¥99.00，库存45）
- Python编程：从入门到实践（¥79.00，库存65）
- 设计模式（¥88.00，库存35）
- 算法导论（¥128.00，库存30）
- 深入理解计算机系统（¥118.00，库存25）
- 编程珠玑（¥69.00，库存40）

**文学类（分类ID=2）：**
- 百年孤独（¥55.00，库存100）
- 活着（¥39.00，库存80）
- 红楼梦、西游记、三国演义、水浒传（四大名著）
- 围城、平凡的世界等

**其他类别：** 历史、科学、艺术、哲学、心理学、经济、管理、生活等类别均有相应图书。

### 5.5 视图实现

#### 5.5.1 活跃用户视图

```sql
CREATE VIEW v_active_users AS
SELECT id, username, email, role, created_at, updated_at
FROM users
WHERE status = 'active';
```

**应用场景：** 管理员查看当前可用用户列表。

#### 5.5.2 图书分类视图

```sql
CREATE VIEW v_book_with_category AS
SELECT
  b.id,
  b.title,
  b.author,
  c.name AS category,
  b.description,
  b.price,
  b.stock,
  b.rating,
  b.image,
  b.status,
  b.created_at,
  b.updated_at
FROM books b
LEFT JOIN categories c ON b.category_id = c.id;
```

**应用场景：** 前端展示图书列表时，直接获取分类名称，无需额外查询。

#### 5.5.3 热门图书视图

```sql
CREATE VIEW v_popular_books AS
SELECT
  b.id,
  b.title,
  b.author,
  b.price,
  b.rating,
  COUNT(r.id) AS review_count
FROM books b
LEFT JOIN reviews r ON b.id = r.book_id
WHERE b.rating >= 4.5
GROUP BY b.id
ORDER BY b.rating DESC, review_count DESC
LIMIT 10;
```

**应用场景：** 首页展示热门推荐图书。

### 5.6 数据库性能优化

#### 5.6.1 索引优化策略

1. **单列索引**：为经常用于WHERE、ORDER BY、JOIN的字段创建索引
2. **组合索引**：对于经常组合查询的字段，考虑创建组合索引
3. **避免过度索引**：索引会降低写入性能，仅为必要字段创建索引

#### 5.6.2 查询优化建议

1. **使用视图**：复杂关联查询封装为视图，简化前端调用
2. **分页查询**：使用LIMIT和OFFSET进行分页，避免一次性加载大量数据
3. **避免SELECT ***：仅查询需要的字段
4. **使用参数化查询**：防止SQL注入，提高查询缓存命中率

#### 5.6.3 数据库维护

1. **定期分析表**：`ANALYZE TABLE table_name` 更新表统计信息
2. **定期优化表**：`OPTIMIZE TABLE table_name` 整理表碎片
3. **监控慢查询**：启用慢查询日志，优化低效查询
4. **定期备份**：制定备份策略，确保数据安全

### 5.7 数据库完整性约束

#### 5.7.1 实体完整性

- 所有表均设置主键约束
- 主键字段使用AUTO_INCREMENT自动递增
- 确保每条记录唯一可识别

#### 5.7.2 参照完整性

- 使用外键约束确保引用完整性
- 合理设置ON DELETE和ON UPDATE策略：
  - CASCADE：级联删除/更新
  - SET NULL：设置为NULL
  - RESTRICT：限制删除/更新

#### 5.7.3 域完整性

- 使用ENUM类型限制字段取值范围（如role、status）
- 使用NOT NULL约束必填字段
- 使用DEFAULT设置默认值
- 使用UNIQUE约束确保数据唯一性

### 5.8 数据库安全实现

#### 5.8.1 访问控制

```sql
-- 创建只读用户（用于报表查询）
CREATE USER 'report_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT ON bookstore_management_system.* TO 'report_user'@'localhost';

-- 创建应用程序用户（具有增删改查权限）
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON bookstore_management_system.* TO 'app_user'@'localhost';
```

#### 5.8.2 数据加密

- 用户密码使用bcrypt算法加密（成本因子10）
- 敏感字段考虑使用AES加密存储

#### 5.8.3 日志审计

- operation_logs表记录所有关键操作
- 记录操作用户、操作类型、操作时间、IP地址等信息
- 便于安全审计和问题追溯

---

## 总结

本章详细介绍了线上书店管理系统的系统功能结构设计、数据库设计和数据库实现。系统采用前后端分离架构，使用Vue 3和Flask构建，数据库使用MySQL实现。

**系统特点：**

1. **模块化设计**：系统功能划分为用户管理、图书管理、订单管理、评论评分、系统管理五大模块，职责清晰。

2. **权限控制**：实现基于角色的访问控制（RBAC），通过角色和权限的多对多关系实现灵活的权限管理。

3. **数据完整性**：通过主键、外键、唯一约束等确保数据完整性和一致性。

4. **性能优化**：合理创建索引，设计视图简化查询，提高系统性能。

5. **安全保障**：密码加密存储，参数化查询防止SQL注入，操作日志记录便于审计。

6. **扩展性**：数据库设计预留扩展空间，便于未来功能扩展。

该系统为在线书店提供了完善的管理功能，满足管理员和普通用户的不同需求，具有良好的实用性和可维护性。
